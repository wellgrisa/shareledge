function toDateTime(e){if(void 0==e)return"";var t=new Date(e);return void 0==t?"":padLeft(t.getDate())+"/"+padLeft(t.getMonth())+"/"+t.getFullYear()+" "+padLeft(t.getHours())+":"+padLeft(t.getMinutes())}function padLeft(e,t,n){void 0==t&&(t="0"),void 0==n&&(n="2");for(var i="",o=0;n>o;o++)i+=t;return i.substring(0,i.length-e.toString().length)+e}function setupAjax(){$.ajaxSetup({complete:function(e){var t=$.xhrPool.indexOf(e);t>-1&&$.xhrPool.splice(t,1)}}),$(document).ajaxStart(function(){$("#accordion").addClass("loading"),NProgress.inc()}).ajaxStop(function(){$("#accordion").removeClass("loading"),NProgress.done()}).ajaxError(function(e,t,n,i){"Not Found"==i&&(window.location="/")})}function initializeTags(){updateTags(function(e){$(".tokenfield").tokenfield({typeahead:[{highlight:!0,minLength:1},{source:e.ttAdapter()}]})})}function initializeClosePopoverOut(){$("html").on("click",function(e){"popover"!==$(e.target).data("toggle")&&0===$(e.target).parents('[data-toggle="popover"]').length&&0===$(e.target).parents(".popover.in").length&&$('[data-toggle="popover"]').popover("hide")})}function initializeSidebar(){$(".sidebar a").on("click",sidebarClicked)}function initializeIo(){io=io.connect(),io.on("update-counts",function(){$(".answer-collapsible.in").length||""!=getQuestionTrimmed()||$("#outstandingQuestionsByUser").hasClass("questions-selected")||dispatchRefreshQuestions(),updateCounts()}),io.on("answer-rated",function(e){e.answeredBy._id==$("#user-id").val()&&updateUserScore(!0),updateCounts()}),io.on("question-created",function(e){var t="New question created in the section ["+e.type+"] by "+e.user;notificate(t,e.question,e.icon)}),io.on("question-answered",function(e){var t="Question made by "+e.question.createdBy+" answered in the section ["+e.question.type+"] by "+e.user;e.question.createdBy==$("#user-name").val()&&(t="Your question has been answered by "+e.question.updatedBy.username),notificate(t,e.question,e.question.updatedBy.google?e.question.updatedBy.google.picture:"")})}function handleMultiSelect(){var e=$("#filter").val().split(","),t=$("#systems");initMultiSelect(t),t.val(e),t.multiselect("refresh")}function initMultiSelect(e){e.multiselect({buttonWidth:"100%",buttonClass:"btn btn-link",nonSelectedText:i18n.t("main-page.header.system-select"),onChange:systemChanged})}function systemChanged(){jQuery.ajax({url:"/updateFilter",type:"PUT",global:!1,data:{filter:$("#systems").val()},success:function(){console.log("sucess"),$("#filter").val($("#systems").val()),initiateSearch(),updateCounts(),dispatchRefreshQuestions()}})}function initializeControls(){$("#question").focus(),$("#btn-ask").popover({html:!0}),$("body").tooltip({selector:".beautify-tooltip"}),$("body").tooltip({selector:"#group-ask",title:"ai ai"}),$("body").on("hidden.bs.popover",function(){$(".popover:not(.in)").hide().detach()}),$(".notifications span").tooltip()}function processPasteEvent(e){for(var t=0;t<e.clipboardData.items.length;t++){var n=e.clipboardData.items[t],i=n.type;if(-1!=i.indexOf("image")){var o=n.getAsFile(),a=new FileReader;a.onload=function(e){uploadAttachment(e.target.result,cleanTextArea)},insertLoadingTextarea(),a.readAsDataURL(o)}else console.log("Not supported: "+i)}}function downloadFile(){jQuery.ajax({type:"POST",url:"/download",global:!1}).done(function(){})}function insertLoadingTextarea(){doInsert($(document.createElement("div")).html('<img class="icon-loading" src="/img/loading.gif" style="display: block;">')[0])}function uploadAttachment(e,t,n){jQuery.ajax({url:"upload",type:"POST",global:!1,data:{img:e},success:function(e){var i;if("png"==e.ext||"jpg"==e.ext||"jpeg"==e.ext)i=new Image,i.src=e.src;else{var o=n.substr(0,n.lastIndexOf("."))||n,a='<button contenteditable="false"  class="attachment-button" type="button" onclick="window.open(\'/download?filename='+o+"&src="+e.fileName+'\',\'_top\'); return false;"><a class="en-ignore" href="/download?filename='+o+"&src="+e.fileName+'" target="_blank"><img border="0" name="26e5ab31-64b1-4513-af11-a1f5610ba81d" src="img/attachment.png" align="left" style="margin-top: -1px;"> '+n+"</a></button>";i=$(document.createElement("div")).html(a)[0]}doInsert(i),t&&t()},error:function(){}})}function HandleSelectionChange(){var e=window.getSelection&&window.getSelection();e&&e.rangeCount>0&&(savedRange=e.getRangeAt(0))}function doInsert(e){var t=window.getSelection&&window.getSelection();if(t&&t.rangeCount>0){var n=t.getRangeAt(0);n.insertNode(e)}}function drop(e){ignoreDrag(e);var t=e.originalEvent.dataTransfer,n=t.files;if(t.files.length>0){var i=n[0],o=new FileReader;o.onload=function(e){return function(t){uploadAttachment(t.target.result,cleanTextArea,e)}}(i.name),insertLoadingTextarea(),o.readAsDataURL(i,"test")}}function cleanTextArea(){for(var e=$(".textarea",".list-group-item-question.active"),t=e.find("img[src*=data], .icon-loading"),n=0;n<t.length;n++)t[n].remove()}function ignoreDrag(e){e.originalEvent.stopPropagation(),e.originalEvent.preventDefault()}function handleListGroup(){var e=$(".list-group-questions");e.delegate(".answer-collapsible","shown.bs.collapse",function(){var e=$(".textarea",$(".list-group-item-question.active"));e.wysiwyg(),e.off("drop").on("drop",drop),e.keyup(function(e){e.ctrlKey&&13==e.keyCode&&answer()}),e.eq(0).focus()}),e.delegate(".answer-collapsible","show.bs.collapse",function(){$("#accordion .in").collapse("hide");var e=$(".list-group-item-question.active");if(e.hasClass("list-group-item-highlighted")){{e.attr("style")}e.removeClass("list-group-item-highlighted");var t=e.data("id"),n="/question/updateRead/"+t;jQuery.ajax({url:n,global:!1,type:"PUT",success:function(){console.log("sucess"),updateCounts()}})}}),e.delegate(".list-group-item-question","click",function(e){var t=$(e.currentTarget).closest(".list-group-questions").children(".active");t.removeClass("active"),$(e.currentTarget).addClass("active")})}function openEditQuestionPopup(e){console.log(e),$("#edit-question-tokenfield").tokenfield(),$("#editQuestionModal").modal(),$(".tokenfield").tokenfield("destroy"),$(".tokenfield","#editQuestionModal").tokenfield("disable"),$.ajax({url:"/question/"+e,global:!1}).done(function(e){var t=$(".textarea","#editQuestionModal");t.wysiwyg(),t.html(e.content),updateTags(function(t){$("#edit-question-tokenfield").tokenfield({typeahead:[{highlight:!0,minLength:1},{source:t.ttAdapter()}]}),$(".tokenfield","#editQuestionModal").tokenfield("setTokens",e.tags)},e.tags),$(".tokenfield","#editQuestionModal").tokenfield("enable"),$(".edit-question-btn-save").on("click",function(){updateQuestion({id:e._id,read:e.read,content:$(".textarea","#editQuestionModal").html(),tags:tidyTagsUp($("#edit-question-tokenfield").tokenfield("getTokensList").split(",")),solutions:e.solutions},onEditQuestionCompleted)})})}function updateTags(e,t){$.ajax({url:"/tags",global:!1}).done(function(n){for(var i=[],o=0;o<n.length;o++)i.push({value:n[o].title});var a=new Bloodhound({local:i,datumTokenizer:function(e){return Bloodhound.tokenizers.whitespace(e.value)},queryTokenizer:Bloodhound.tokenizers.whitespace});a.initialize(),e(a,t)})}function finishTour(){var e="/finishTour/"+$("#user-id").val();jQuery.ajax({url:e,global:!1,type:"PUT",success:function(){console.log("sucess")}})}function refreshQuestions(){$.get("/question",function(e){$(".list-group-questions").html("");for(var t=e.data,n=0;n<t.length;n++)$(".list-group-questions").append(getQuestion(t[n]))})}function updatePagination(e){var t=$(".pagination");t.html("");for(var n=1;n<=e.totalPages;n++)t.append(e.currentPage==n?$("<li/>",{"class":"active"}).append('<a href="#">'+n+"</a></li>"):'<li><a href="#">'+n+"</a></li>")}function refreshQuestionsWith(e){var t=e.records,n=$(".pagination");n.html("");for(var i=1;i<=e.pagination.totalPages;i++)n.append(e.pagination.currentPage==i?$("<li/>",{"class":"active"}).append('<a href="#">'+i+"</a></li>"):'<li><a href="#">'+i+"</a></li>");$(".list-group-questions").html("");for(var i=0;i<t.length;i++)$(".list-group-questions").append(getQuestion(t[i]))}function attachClipboardEvent(){var e=new ZeroClipboard($(".clip"));e.on("ready",function(){e.on("copy",function(e){var t=e.clipboardData,n=$(e.target).closest(".list-group-item-question").data("id"),i=$(e.target).siblings(".list-group-item-heading").text().replace(/<img [^>]+>/g,"").replace(/<br>/g,""),o=Helper.getDomain();t.setData("text/plain",$.trim(i)+" "+o+"?id="+n)}),e.on("aftercopy",function(){showSimpleNotification("Question copied to clipboard.","img/copy-icon.png")})})}function sidebarClicked(){$(this).attr("id");if(searchFunction=getQuestionsByLink,!$(this).hasClass("active")){var e=$(this).parent().siblings(".active");e.removeClass("active"),$(this).parent().addClass("active")}$(".pagination").children(".active").removeClass("active"),getQuestionsByLink()}function getQuestionsByLink(e){var t=2;getOutstandingCountByFilter({filter:{criteria:{type:$("#systems").val()},page:t}},refreshQuestionsWith,e)}function getOutstandingCountByFilter(e,t,n){$.getJSON("/questions/outstandingFilter",e).done(function(e){n&&n({data:e.records})}).fail(function(){})}function updateBadge(e,t){var n="#"+e+" .label";$(n).length?$(n).text(t):$("#"+e).append('<span class="label label-primary">'+t+"</span>")}function updateBadges(e){updateBadge("my-questions",e.myQuestions),updateBadge("my-answered-questions",e.myAnsweredQuestions),updateBadge("my-outstanding-questions",e.myOutstandingQuestions),updateBadge("outstanding-questions",e.outstandingQuestions),updateBadge("answered-outstanding-questions",e.answeredOutstandingQuestions),updateBadge("all-questions",e.allQuestions)}function updateQuestion(e,t){var n="/question/"+e.id;jQuery.ajax({url:n,type:"PUT",data:e,success:function(){t()}})}function onEditQuestionCompleted(){onEditCompleted("#editQuestionModal")}function onEditAnswerCompleted(){onEditCompleted("#editAnswerModal")}function onEditCompleted(e){$(".tokenfield",e).tokenfield("setTokens",""),$(".textarea",e).html(""),$(e).modal("hide"),dispatchRefreshQuestions(),$(".edit-question-btn-save").off("click")}function ask(e){var t=getQuestionMade();return""==t?void alertUser("danger",i18n.t("main-page.messages.question-required")):$("#systems").val()?void jQuery.post("/question",{content:t.content,tags:t.tags,type:$("#systems").val()},function(t){alertUser("success",i18n.t("main-page.messages.question-successful")),$("#question").val(""),$(".token").remove(),$(".detailed-question").html(""),e&&$("#main-navbar").popover("hide"),$("#nav-input-wonder").next().hasClass("popover")&&$("#nav-input-wonder").popover("hide"),initiateSearch(),io.emit("question-created",{user:$("#user-name").val(),type:$("#systems").val(),question:{id:t._id,type:t.type},icon:$("#user-avatar").attr("src")}),updateCounts(),dispatchRefreshQuestions(),updateUserScore(!0),ga_event("Question","Ask","Question saved as outstading")}):void alertUser("danger",i18n.t("main-page.messages.system-required"))}function updateUserScore(e){$.ajax({url:"/score/"+$("#user-id").val(),global:!1}).done(function(t){updateScore(t.points);var n=t.points-$("#user-points").val();$("#user-points").val(t.points),e&&n>0&&showSimpleNotification("Congratulations, you have got "+n+" points.","img/star.png")})}function updateScore(e){$(".score").html(e)}function alertUser(e,t){var n=buildPanel(e,t);$(".alert-panel").append(n),setTimeout(function(){$(".alert",".alert-panel").fadeOut("slow")},2e3)}function buildPanel(e,t){var n=[];return n.push('<div class="alert alert-'+e+'">'),n.push('<a href="#" class="close" data-dismiss="alert">&times;</a>'),n.push(t),n.push("</div>"),n.join("")}function answer(){var e=$(".list-group-item-question.active"),t=e.data("id"),n="/question/"+t;$.get(n,function(t){t.solutions.push({content:$(".textarea",e).html()}),registerAnswer(t)})}function updateCounts(){$.ajax({url:"/counts",global:!1}).done(function(e){updateBadges(e.data)})}function initiateSearch(){$(".sidebar").children(".active").removeClass("active"),$("#outstanding-questions").parent().addClass("active");var e=$("li.active > a",".pagination").html();return""!=getParameterByName("id")?void getOutstandingCountByFilter({filter:{criteria:{_id:getParameterByName("id")},page:e}},refreshQuestionsWith):void 0}function registerAnswer(e){var t=$(".list-group-item-question.active");e.read=!1;var n=t.data("id"),i="/question/"+n;jQuery.ajax({url:i,type:"PUT",data:e,success:function(e){$(".textarea",t).html(""),t.removeClass("active"),$(".answer-collapsible.in").collapse("toggle");var n=e.question;io.emit("question-answered",{user:$("#user-name").val(),question:{id:n._id,type:n.type,createdBy:n.user.username,updatedBy:e.updatedBy}}),updateCounts(),dispatchRefreshQuestions()}})}function deleteQuestion(e){var t="/question/"+e;jQuery.ajax({url:t,type:"DELETE",success:function(){updateUserScore(!1),io.emit("update-counts"),updateCounts(),dispatchRefreshQuestions()}})}function dispatchRefreshQuestions(){var e=document.createEvent("Event");e.initEvent("refreshQuestions",!0,!0),document.dispatchEvent(e)}function showAnswer(){var e=$(".list-group-item-question.active").data("id"),t="/question/updateRead/"+e;jQuery.ajax({url:t,type:"PUT",success:function(){console.log("sucess")}});var n="/question/"+e;$.get(n,function(e){$("#answers").html("");for(var t=0;t<e.solutions.length;t++){var n='<div class="panel panel-default"><div class="panel-heading"><span class="badge">'+e.solutions[t].useful+"</span><label>"+e.solutions[t].user.username+"</label> "+toDateTime(e.solutions[t].created)+"<a onclick=\"rateUp('"+e.solutions[t]._id+'\')" class="answer-result green" href="#"><span class="glyphicon glyphicon-ok"></span></a></div><div class="panel-body">'+e.solutions[t].content+"</div></div>";$("#answers").append(n)}}),$(".answer-panel").fadeIn("slow")}function onDeleteAnswerClicked(e,t){var n="/answer/"+e;jQuery.ajax({url:n,global:!1,type:"DELETE",data:{answer:t},success:function(){updateCounts(),dispatchRefreshQuestions()}})}function getShortAnswers(e){for(var t="",n=0;n<e.length;n++)t+=$($.parseHTML(e[n].content)).text();var i="...";return t.length<=120&&(i=""),t.substr(0,120)+i}function getLastUpdate(e){var t=(new Date).getTime()-e;t/=1e3;var n=Math.floor(t%60);t/=60;var i=Math.floor(t%60);t/=60;var o=Math.floor(t%24),a=Math.floor(t/24);return a>0?a+" days":o>0&&24>o?o+" hours":i>0&&60>i?i+" minutes":n+" seconds"}function buildAnswerPanel(){var e=[];return e.push('<div class="panel-answer">'),e.push('<div class="textarea" data-ph="Your answer goes here..."></div>'),e.push('<div class="panel-bottom-answer">'),e.push('<button onclick="answer()" class="btn btn-default btn-answer" type="submit">Register</button>'),e.push("</div>"),e.push("</div>"),e.join("")}function buildQuestionPanel(){var e=[];return e.push('<div class="panel-detailed-question">'),e.push('<div class="detailed-question textarea" data-ph="Your question goes here..."></div>'),e.push('<div class="panel-bottom-question">'),e.push('<div class="input-group">'),e.push('<input type="text" id="tags" class="tokenfield" title="Tag here" class="form-control" placeholder="Press tab or enter to insert a new tag">'),e.push('<span class="input-group-btn"><button onclick="ask(true)" class="btn btn-info" type="submit">'+i18n.t("main-page.header.ask")+"</button></span>"),e.push("</div>"),e.push("</div>"),e.join("")}function buildTagPanel(){var e=[];return e.push('<div class="input-group">'),e.push('<input type="text" class="tokenfield" name="question" title="Tag here" class="form-control" placeholder="Press tab or enter to insert a new tag">'),e.push('<span class="input-group-btn"><button onclick="ask()" class="btn btn-info btn-ask">'+i18n.t("main-page.question-panel.register")+"?</button></span>"),e.push("</div>"),e.join("")}function getQuestionMade(){return $("#main-navbar").next("div.popover.in").length?{content:$(".detailed-question").html(),tags:$(".detailed-question-popover .tokenfield").length?tidyTagsUp($(".detailed-question-popover .tokenfield").tokenfield("getTokensList").split(",")):""}:{content:$("#question").val(),tags:$(".simple-question-popover .tokenfield").length?tidyTagsUp($(".simple-question-popover .tokenfield").tokenfield("getTokensList").split(",")):""}}function tidyTagsUp(e){for(var t=0;t<e.length;t++)e[t]=$.trim(e[t]);return e}function handleDetailedQuestionPopover(){var e=$("#main-navbar"),t=$("#question");e.on("hide.bs.popover",function(){$("#main-navbar").next().hasClass("popover")&&(t.removeAttr("disabled"),$("#btn-ask").removeAttr("disabled","disabled").addClass("btn-info").removeClass("btn-default"))}).on("shown.bs.popover",function(){$(".panel-detailed-question").is(":visible")&&$(".panel-detailed-question").closest(".popover.in").length&&(t.attr("disabled","disabled"),$("#btn-ask").attr("disabled","disabled").toggleClass("btn-info").toggleClass("btn-default"));var e=$(".detailed-question");e.wysiwyg(),""!=t.val()&&e.html(t.val()),e.focus(),e.keyup(function(e){window.event?event:e;return e.ctrlKey&&13==e.keyCode?void ask(!0):void 0})})}function configureEvents(){handleDetailedQuestionPopover(),$(".navbar-fixed-top").on("shown.bs.popover",function(){updateTags(function(e){$(".tokenfield").tokenfield({typeahead:[{highlight:!0,minLength:1},{source:e.ttAdapter()}]})})}),$("#question").keyup(function(e){var t=window.event?event:e;13==t.keyCode&&(tagging(),$(".btn-ask").focus())}),window.addEventListener("paste",processPasteEvent)}function requestPermission(){"Notification"in window&&"denied"!==Notification.permission&&Notification.requestPermission(function(e){Notification.permission!==e&&(Notification.permission=e)})}function onNotificationClicked(e){$('[data-id="'+e+'"]').addClass("list-group-item-highlighted"),window.focus()}function notificate(e,t,n){"Notification"in window&&("granted"===Notification.permission?showNotification(e,t,n):"denied"!==Notification.permission&&Notification.requestPermission(function(i){"permission"in Notification||(Notification.permission=i),"granted"===i&&showNotification(e,t,n)}))}function showNotification(e,t,n){if($("#systems").val()==t.type){var i=new Notification(e,{icon:n});setTimeout(function(){i.close()},7e3),i.onclick=function(){onNotificationClicked(t.id)}}}function showSimpleNotification(e,t){if("Notification"in window){var n=new Notification(e,{icon:t});setTimeout(function(){n.close()},7e3),n.onclick=function(){onNotificationClicked(question.id)}}}function askDetailedQuestion(){var e=$("#main-navbar"),t=$("#nav-input-wonder").width();$("#nav-input-wonder").next().hasClass("popover")&&$("#nav-input-wonder").popover("hide"),createPopover("detailed-question-popover",e,buildQuestionPanel(t),t)}function tagging(){var e=$("#nav-input-wonder"),t=e.width();createPopover("simple-question-popover",$("#nav-input-wonder"),buildTagPanel(),t)}function createPopover(e,t,n,i){var o=i?'style="max-width : '+i+"px; width :"+i+'px"':"",a='<div class="'+e+' timePickerWrapper popover"'+o+">",s=[a,'<div class="arrow"></div>','<div class="popover-content">',"</div>","</div>"].join("");t.popover({content:n,template:s,placement:"bottom",html:!0,trigger:"manual"}),t.popover("toggle")}function getQuestionTrimmed(){return $.trim(getQuestionMade().content.replace(/<img [^>]+>/g,"").replace(/<br>/g,"")).replace(/ +/g," ").toLowerCase()}function getConditions(){var e=getQuestionTrimmed(),t=e.split(" "),n=Helper.ToRegexArray(t,"content"),i=Helper.ToRegexArray(t,"tags"),o=Helper.ToRegex(e);return[{content:o},{$and:n},{$or:i}]}function getTags(){var e=getQuestionTrimmed();return $.grep(e.split(" "),function(e){return e})}function buildSearchData(e){getConditions();return{filter:{criteria:{type:$("#systems").val(),$text:{$search:getQuestionTrimmed()}},projection:{score:{$meta:"textScore"}},page:e,orderby:{score:{$meta:"textScore"}}}}}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))}function onCommentClicked(){this.event.stopPropagation()}var Helper={ToRegex:function(e,t,n){void 0==n&&(n="i");var i={$regex:e,$options:n};if(void 0==t)return i;var o={};return o[t]=i,o},ToRegexArray:function(e,t){var n=new Array(e.length);for(i=0;i<e.length;i++)n[i]=Helper.ToRegex(e[i],t);return n},getDomain:function(){var e=window.location.href;return e.substring(0,e.indexOf("/",e.indexOf("//")+2)+1)}};$(document).ready(function(){requestPermission(),setupAjax(),initializeTags(),i18n&&i18n.init(handleMultiSelect),initializeClosePopoverOut(),initializeSidebar(),initializeIo(),initializeControls(),configureEvents(),updateCounts(),initiateSearch()}),$.xhrPool=[],$.xhrPool.abortAll=function(){$(this).each(function(e,t){t.abort()}),$.xhrPool.length=0};